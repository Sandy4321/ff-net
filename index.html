<!DOCTYPE html>

<html>
<head>
<style>

svg {
	background-color: #FFF;
	cursor: default;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	-o-user-select: none;
	user-select: none;
}

svg:not(.active):not(.ctrl) {
	/* cursor: crosshair; */
}

path.link {
	fill: none;
	stroke: #000;
	stroke-width: 4px;
	cursor: default;
}

svg:not(.active):not(.ctrl) path.link {
	cursor: pointer;
}

path.link.selected {
	stroke-dasharray: 10,2;
}

path.link.hidden {
	stroke-width: 0;
}

circle.node {
	stroke-width: 1.5px;
	cursor: pointer;
}

circle.node.reflexive {
	stroke: #000 !important;
	stroke-width: 2.5px;
}

text {
	font: 12px sans-serif;
	pointer-events: none;
}

text.id {
	text-anchor: middle;
	font-weight: bold;
}

</style>

<script src="lib/d3/d3.js" charset="utf-8"></script>
<script src="js/Vector2.js" charset="utf-8"></script>

<script>

var Link;
(function () {
Link = function(n0, nf, weight) {
	this.init(n0, nf, weight);
}

var p = Link.prototype;
p.n0 = null;
p.nf = null;
p.weight = null;

p.init = function(n0, nf, weight) {
	this.n0 = n0;
	this.nf = nf;
	this.weight = weight;
}

})();

var Neuron;
(function() {
Neuron = function(pos) {
	this.init(pos);
}

var p = Neuron.prototype;

p.pos = null;
p.links = null;

p.init = function(pos) {
	this.links = [];
	this.pos = pos;
}

})();

var Spike;
(function() {
Spike = function(link) {
	this.init(link);
}

var p = Spike.prototype;

p.pos = null;
p.link = null;

p.init = function(link) {
	this.link = link;
	this.pos = new Vector2(0, 0);
}
})();

var NeuralNet;

(function () {
NeuralNet = function() {
	this.init();
}

var p = NeuralNet.prototype;
p.neurons = null;
p.links = null;
p.spikes = null;
p.input = null;
p.output = null;

p.init = function() {
	this.neurons = [];
	this.links = [];
	this.spikes = [];
	this.input = [];
	this.output = [];
}

p.addNeuron = function(pos) {
	var neuron = new Neuron(pos);
	this.neurons.push(neuron);
	return neuron;
}

p.addLink = function(n0, nf, weight) {
	var link = new Link(n0, nf, weight);
	n0.links.push(link);
	var spike = new Spike(link);
	link.spike = spike;
	this.links.push(link);
	this.spikes.push(spike);
	return link;
}

})();

function init() {
	var width = 960;
	var height = 500;
	var colors = d3.scale.category10();
	var neuronRadius = 12;
	var spikeRadius = 4;

	var neuralNet = new NeuralNet();
	neuralNet.addNeuron(new Vector2(500, 300));
	neuralNet.addNeuron(new Vector2(500, 400));
	neuralNet.addNeuron(new Vector2(400, 300));
	neuralNet.addNeuron(new Vector2(400, 400));
	neuralNet.addNeuron(new Vector2(300, 350));
	neuralNet.addLink(neuralNet.neurons[0], neuralNet.neurons[2], 1);
	neuralNet.addLink(neuralNet.neurons[0], neuralNet.neurons[3], 1);
	neuralNet.addLink(neuralNet.neurons[1], neuralNet.neurons[2], 1);
	neuralNet.addLink(neuralNet.neurons[1], neuralNet.neurons[3], 1);
	neuralNet.addLink(neuralNet.neurons[2], neuralNet.neurons[4], 1);
	neuralNet.addLink(neuralNet.neurons[3], neuralNet.neurons[4], 1);
	neuralNet.input = [neuralNet.neurons[0], neuralNet.neurons[1]];

	var nodes = neuralNet.neurons;
	var links = neuralNet.links;
	var spikes = neuralNet.spikes;

	var svg = d3.select('body')
		.append('svg')
		.attr('width', width)
		.attr('height', height);

	var path = svg.append('svg:g').selectAll('path');
	var circle = svg.append('svg:g').selectAll('g');
	var d3Spike = svg.append('svg:g').selectAll('g');

	var t = 0;
	var propagationT = 200;
	var firingNeurons = neuralNet.input;
	restart();

	setInterval(tick, 1 / 30);

	function tick() {
		if (t >= propagationT) {
			t = propagationT;
			var newFiringNeurons = [];
			for (var i = 0; i < firingNeurons.length; i++) {
				var neuron = firingNeurons[i];
				for (var j = 0; j < neuron.links.length; j++) {
					var link = neuron.links[j];
					newFiringNeurons.push(link.nf);
				}
			}
			firingNeurons = newFiringNeurons;
			t = 0;
		} else {
			t++;
		}

		for (var i = 0; i < firingNeurons.length; i++) {
			for (var j = 0; j < firingNeurons[i].links.length; j++) {
				var spike = firingNeurons[i].links[j].spike;
				var link = spike.link;

				var v = link.nf.pos.subtract(link.n0.pos).normalize();
				var p0 = link.n0.pos.add(v.times(neuronRadius - spikeRadius));
				var pf = link.nf.pos.subtract(v.times(neuronRadius - spikeRadius));
				v = pf.subtract(p0);
				spike.pos = p0.add(v.times(t / propagationT));
			}
		}

		// draw directed edges with proper padding from node centers
		path.attr('d', function(d) {
			var deltaX = d.nf.pos.x - d.n0.pos.x,
					deltaY = d.nf.pos.y - d.n0.pos.y,
					dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
					normX = deltaX / dist,
					normY = deltaY / dist,
					sourcePadding = d.left ? neuronRadius - 5 : neuronRadius,
					targetPadding = d.right ? neuronRadius - 5: neuronRadius,
					sourceX = d.n0.pos.x + (sourcePadding * normX),
					sourceY = d.n0.pos.y + (sourcePadding * normY),
					targetX = d.nf.pos.x - (targetPadding * normX),
					targetY = d.nf.pos.y - (targetPadding * normY);
			return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
		});

		circle.attr('transform', function(d) {
			return 'translate(' + d.pos.x + ',' + d.pos.y + ')';
		});

		d3Spike.attr('transform', function(d) {
			return 'translate(' + d.pos.x + ',' + d.pos.y + ')';
		});
	}

	function restart() {
		path = path.data(links);

		path.classed('selected', function(d) { return false; })
			.style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
			.style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; });

		path.enter().append('svg:path')
		.attr('class', 'link')
		.style('stroke-width', function(d) { return 2; } )
		.classed('selected', function(d) { return false; })
		.style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
		.style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; });

		path.exit().remove();

		circle = circle.data(nodes);
		circle.selectAll('circle')
		.style('fill', function(d) { return d3.rgb(colors(1)); })
		.classed('reflexive', function(d) { return d.reflexive; });

		var g = circle.enter().append('svg:g');

		g.append('svg:circle')
		.attr('class', 'node')
		.attr('r', neuronRadius)
		.style('fill', function(d) { return d3.rgb(colors(1)); })
		.style('stroke', function(d) { return d3.rgb(colors(1)).darker().toString(); });

		circle.exit().remove();

		d3Spike = d3Spike.data(spikes);
		g = d3Spike.enter().append('svg:g');

		g.append('svg:circle')
		.attr('class', 'node')
		.attr('r', spikeRadius)
		.style('fill', function(d) { return d3.rgb(colors(0)); })
		.style('stroke', function(d) { return d3.rgb(colors(0)).darker().toString(); });

		d3Spike.exit().remove();

	}

}

</script>

</head>
<body onload="init()">
</body>
</html>
