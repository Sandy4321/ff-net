<!DOCTYPE html>

<html>
<head>
<style>

svg {
	background-color: #FFF;
	cursor: default;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	-o-user-select: none;
	user-select: none;
}

svg:not(.active):not(.ctrl) {
	cursor: crosshair;
}

path.link {
	fill: none;
	stroke: #000;
	stroke-width: 4px;
	cursor: default;
}

svg:not(.active):not(.ctrl) path.link {
	cursor: pointer;
}

path.link.selected {
	stroke-dasharray: 10,2;
}

path.link.dragline {
	pointer-events: none;
}

path.link.hidden {
	stroke-width: 0;
}

circle.node {
	stroke-width: 1.5px;
	cursor: pointer;
}

circle.node.reflexive {
	stroke: #000 !important;
	stroke-width: 2.5px;
}

text {
	font: 12px sans-serif;
	pointer-events: none;
}

text.id {
	text-anchor: middle;
	font-weight: bold;
}

</style>

<script src="lib/d3/d3.js" charset="utf-8"></script>

<script>

var Synapse;
(function () {
Synapse = function(n0, nf, weight) {
	this.init(n0, nf, weight);
}

var p = Synapse.prototype;
p.n0 = null;
p.nf = null;
p.weight = null;

p.init = function(n0, nf, weight) {
	this.n0 = n0;
	this.nf = nf;
	this.weight = weight;
}

})();

var Neuron;
(function () {
Neuron = function() {
	this.init();
}

var p = Neuron.prototype;

p.synapses = null;

p.init = function() {
	this.synapses = [];
}

})();

var NeuralNet;

(function () {
NeuralNet = function() {
	this.init();
}

var p = NeuralNet.prototype;
p.inputNeurons = null;
p.outputNeurons = null;

p.init = function() {
	this.inputNeurons = [];
	this.outputNeurons = [];

	this.inputNeurons.push(new Neuron());
	this.inputNeurons.push(new Neuron());
	this.inputNeurons.push(new Neuron());
}

p.getD3DataRec = function(level, node) {
	var data = {};
	data.name = "" + level + ":" + node.char;
	data.children = [];
	data.node = node;

	for (var i in node.children) {
		var childData = this.getD3DataRec(level + 1, node.children[i]);
		childData.parent = data.name;
		data.children.push(childData);
	}

	return data;
}

p.getD3Data = function() {
	var nodeData = this.getD3DataRec(0, this.root);
	nodeData.parent = "null";
	return [nodeData];
}

})();

function init() {
	var width = 960;
	var height = 500;
	var colors = d3.scale.category10();

	var svg = d3.select('body')
		.append('svg')
		.attr('width', width)
		.attr('height', height);

	var nodes = [
		{id: 0, reflexive: false, x: 558, y: 300},
		{id: 1, reflexive: false, x: 558, y: 290},
		{id: 2, reflexive: false, x: 358, y: 290},
		{id: 3, reflexive: false, x: 400, y: 300},
		{id: 4, reflexive: false, x: 410, y: 250}
	];
	var lastNodeId = 2;
	var links = [
		{source: nodes[0], target: nodes[3], left: false, right: true, weight: 1},
		{source: nodes[1], target: nodes[3], left: false, right: true, weight: 0.5},
		{source: nodes[0], target: nodes[4], left: false, right: true, weight: 0.3},
		{source: nodes[1], target: nodes[4], left: false, right: true, weight: 0.2},

		{source: nodes[3], target: nodes[2], left: false, right: true, weight: 0.3},
		{source: nodes[4], target: nodes[2], left: false, right: true, weight: 0.2}
	];

	var spikes = [
		{x: nodes[0].x, y: nodes[0].y, source: nodes[0], target: nodes[3]}
	];

	var force = d3.layout.force()
		.nodes(nodes)
		.links(links)
		.size([width, height])
		.linkDistance(150)
		.charge(-500)
		.on('tick', tick);

	svg.append('svg:defs').append('svg:marker')
			.attr('id', 'end-arrow')
			.attr('viewBox', '0 -5 10 10')
			.attr('refX', 6)
			.attr('markerWidth', 3)
			.attr('markerHeight', 3)
			.attr('orient', 'auto')
		.append('svg:path')
			.attr('d', 'M0,-5L10,0L0,5')
			.attr('fill', '#000');

	svg.append('svg:defs').append('svg:marker')
			.attr('id', 'start-arrow')
			.attr('viewBox', '0 -5 10 10')
			.attr('refX', 4)
			.attr('markerWidth', 3)
			.attr('markerHeight', 3)
			.attr('orient', 'auto')
		.append('svg:path')
			.attr('d', 'M10,-5L0,0L10,5')
			.attr('fill', '#000');

	var dragLine = svg.append('svg:path')
		.attr('class', 'link dragline hidden')
		.attr('d', 'M0,0L0,0');

	var path = svg.append('svg:g').selectAll('path');
	var circle = svg.append('svg:g').selectAll('g');
	var spike = svg.append('svg:g');

	var t = 0;
	var propagationT = 50;

	function tick() {
		if (t >= propagationT) {
			t = propagationT;
		} else {
			t++;
		}

		// draw directed edges with proper padding from node centers
		path.attr('d', function(d) {
			var deltaX = d.target.x - d.source.x,
					deltaY = d.target.y - d.source.y,
					dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
					normX = deltaX / dist,
					normY = deltaY / dist,
					sourcePadding = d.left ? 17 : 12,
					targetPadding = d.right ? 15 - d.weight : 12,
					sourceX = d.source.x + (sourcePadding * normX),
					sourceY = d.source.y + (sourcePadding * normY),
					targetX = d.target.x - (targetPadding * normX),
					targetY = d.target.y - (targetPadding * normY);
			return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
		});

		circle.attr('transform', function(d) {
			return 'translate(' + d.x + ',' + d.y + ')';
		});

		spike.attr('transform', function(d) {
			var v = {x: d.target.x - d.source.x, y: d.target.y - d.source.y};
			// var magnitude = Math.sqrt(v.x * v.x + v.y * v.y);
			d.x = d.source.x + v.x * t / propagationT;
			d.y = d.source.y + v.y * t / propagationT;
			return 'translate(' + d.x + ',' + d.y + ')';
		});
	}

	function restart() {
		path = path.data(links);

		path.classed('selected', function(d) { return false; })
			.style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
			.style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; });

		path.enter().append('svg:path')
		.attr('class', 'link')
		.style('stroke-width', function(d) { return 10 * d.weight; } )
		.classed('selected', function(d) { return false; })
		.style('marker-start', function(d) { return d.left ? 'url(#start-arrow)' : ''; })
		.style('marker-end', function(d) { return d.right ? 'url(#end-arrow)' : ''; });

		path.exit().remove();

		circle = circle.data(nodes, function(d) { return d.id; });
		circle.selectAll('circle')
		.style('fill', function(d) { return d3.rgb(colors(d.id)); })
		.classed('reflexive', function(d) { return d.reflexive; });

		var g = circle.enter().append('svg:g');

		g.append('svg:circle')
		.attr('class', 'node')
		.attr('r', 12)
		.style('fill', function(d) { return d3.rgb(colors(d.id)); })
		.style('stroke', function(d) { return d3.rgb(colors(d.id)).darker().toString(); })
		.classed('reflexive', function(d) { return d.reflexive; });

		spike.data(spikes);
		spike
		.attr('transform', function(d) { return 'translate(' + '300' + ',' + '300' + ')' })
		.append('svg:circle')
		.attr('class', 'node')
		.attr('r', 12)
		.style('fill', function(d) { return d3.rgb(colors(0)); })
		.style('stroke', function(d) { return d3.rgb(colors(0)).darker().toString(); });


		circle.exit().remove();
		force.start();
	}

	restart();

}

</script>

</head>
<body onload="init()">
</body>
</html>
